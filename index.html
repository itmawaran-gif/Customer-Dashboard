<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Customer Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

<style>
  /* ===== Base ===== */
  body { transition: .3s; background: #f8f9fa; color: #212529; }

  /* ===== Dark Mode ===== */
  .dark { background: #1e1e2f !important; color: #f0f0f0 !important; }
  .dark .card { background: #2a2a3d !important; color: #f0f0f0 !important; border-color: #3a3a55 !important; }
  .dark .table { color: #f0f0f0 !important; }
  .dark .table-bordered td, .dark .table-bordered th { border-color: #3a3a55 !important; }
  .dark .table-hover tbody tr:hover { background: #35355a !important; color: #fff !important; }

  /* Dark mode filters area */
  .dark #filtersArea {
    background: #2a2a3d !important;
    border-color: #3a3a55 !important;
  }
  .dark .filter-label { color: #c0c8e0 !important; }

  /* Dark mode Choices.js ‚Äî inner box */
  .dark .choices__inner {
    background: #1e1e2f !important;
    border-color: #555 !important;
    color: #f0f0f0 !important;
  }
  /* Selected tags */
  .dark .choices__item--selectable {
    background: #0d6efd !important;
    color: #fff !important;
  }
  /* Input text */
  .dark .choices__input {
    background: transparent !important;
    color: #f0f0f0 !important;
  }
  /* Dropdown list */
  .dark .choices__list--dropdown {
    background: #2a2a3d !important;
    border-color: #555 !important;
    color: #f0f0f0 !important;
  }
  /* Dropdown options */
  .dark .choices__list--dropdown .choices__item {
    color: #f0f0f0 !important;
  }
  .dark .choices__list--dropdown .choices__item--selectable:hover,
  .dark .choices__list--dropdown .choices__item.is-highlighted {
    background: #0d6efd !important;
    color: #fff !important;
  }
  /* Search input inside dropdown */
  .dark .choices__list--dropdown .choices__input {
    background: #1e1e2f !important;
    color: #f0f0f0 !important;
    border-bottom-color: #555 !important;
  }
  /* Placeholder */
  .dark .choices__placeholder { color: #999 !important; }

  /* ===== Card & Map ===== */
  .card { border-radius: 16px; margin-bottom: 1rem; }
  #map { height: 500px; border-radius: 16px; }

  /* ===== Table ===== */
  .table-wrapper { max-height: 400px; overflow: auto; }
  td {
    max-width: 180px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    transition: .2s;
    vertical-align: middle;
  }
  td.expand { white-space: normal; }

  /* ===== Filters Area ===== */
  #filtersArea {
    display: none;
    gap: 12px;
    flex-wrap: wrap;
    padding: 14px;
    background: #eef1f5;
    border-radius: 12px;
    margin-bottom: 14px;
    border: 1px solid #dee2e6;
    position: relative;
    z-index: 1100;
  }
  #filtersArea.visible { display: flex; }

  .filter-item {
    display: flex;
    flex-direction: column;
    min-width: 160px;
    flex: 1 1 160px;
    position: static;
  }
  .filter-label {
    font-size: 0.75rem;
    font-weight: bold;
    margin-bottom: 4px;
    color: #444;
  }
  .filter-item .choices { width: 100% !important; }
  .filter-item .choices__inner {
    min-height: 36px;
    padding: 3px 8px;
    border-radius: 8px;
    font-size: 0.82rem;
  }

  /* Dropdowns always on top */
  .choices__list--dropdown { z-index: 99999 !important; }

  /* ===== Dashboard ===== */
  .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
  .dashboard-card {
    background: #0d6efd; color: #fff;
    padding: 10px; border-radius: 10px;
    text-align: center; cursor: pointer; transition: .2s;
    font-size: 0.85rem;
  }
  .dashboard-card:hover { opacity: .85; transform: scale(1.03); }

  /* ===== Header bar ===== */
  .header-bar {
    display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 1rem;
    flex-wrap: wrap; gap: 8px;
  }
  .header-bar h2 { margin: 0; }
  .header-bar span { font-weight: bold; font-size: 1.1rem; }

  /* Filter badge */
  .btn-filter-toggle { position: relative; }
  #filterBadge {
    position: absolute; top: -6px; right: -6px;
    background: #dc3545; color: #fff;
    border-radius: 50%; font-size: 0.68rem;
    width: 18px; height: 18px;
    display: none; align-items: center; justify-content: center;
    font-weight: bold;
  }
</style>
</head>
<body>
<div class="container-fluid mt-3">

  <!-- Header -->
  <div class="header-bar">
    <h2>üóÇÔ∏è Smart Customer Dashboard</h2>
    <span id="totalCount">Total Customers: 0</span>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-filter-toggle" onclick="toggleFilters()">
        üîç Filters
        <span id="filterBadge">0</span>
      </button>
      <button class="btn btn-dark" onclick="toggleDark()">üåô Dark Mode</button>
    </div>
  </div>

  <!-- Filters Area -->
  <div id="filtersArea"></div>

  <!-- Map + Dashboard -->
  <div class="row g-3">
    <div class="col-md-9">
      <div class="card shadow p-2">
        <div id="map"></div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card shadow p-2">
        <h6 class="text-center mb-2">Customers by Salesman</h6>
        <div id="dashboard" class="dashboard-grid"></div>
      </div>
    </div>
  </div>

  <!-- Data Table -->
  <div class="card shadow mt-3">
    <div class="card-body">
      <div class="table-wrapper">
        <table class="table table-bordered table-hover table-sm" id="dataTable">
          <thead class="table-dark"></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzUzSTIXhzWrGBiSDvBRYIprWtvJUIPemdvSwXaAAXM0cYUaAMS3O-zmqvKhDdANUyU/exec";

const HIDDEN_COLS  = ["Latitude", "Longitude", "check1", "check2", "location", "Photo"];
const FILTER_COLS  = ["Salesman", "City", "Category", "Rating", "Visit Days", "Rymax"];
const DATE_COLS    = ["Date", "date"];

let currentData = [];
let choicesInstances = {};
let filtersVisible = false;
let map = L.map('map').setView([36.3, 43.1], 7);
let heatLayer = null;
let markers = [];

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// ===== Dark Mode =====
function toggleDark() {
  document.body.classList.toggle("dark");
}

// ===== Toggle Filters =====
function toggleFilters() {
  filtersVisible = !filtersVisible;
  document.getElementById("filtersArea").classList.toggle("visible", filtersVisible);
}

// ===== Format date (date only, no time) =====
function formatDate(val) {
  if (!val) return "";
  const str = String(val);
  const match = str.match(/^(\d{4}-\d{2}-\d{2})/);
  if (match) return match[1];
  const d = new Date(val);
  if (!isNaN(d.getTime())) return d.toLocaleDateString('en-CA');
  return str;
}

function cellValue(col, val) {
  if (val == null || val === "") return "";
  if (DATE_COLS.some(dc => col.toLowerCase().includes(dc.toLowerCase()))) return formatDate(val);
  return val;
}

// ===== Load Data =====
async function loadData() {
  try {
    const res  = await fetch(API_URL);
    const data = await res.json();
    currentData = data;
    buildFilters(data);
    const visibleHeaders = Object.keys(data[0]).filter(h => !HIDDEN_COLS.includes(h));
    buildTableHeader(visibleHeaders);
    renderRows(data);
    renderDashboard(data);
    updateMap(data);
  } catch (e) {
    console.error("Error loading data:", e);
  }
}

// ===== Build Filters =====
function buildFilters(data) {
  const area = document.getElementById("filtersArea");
  area.innerHTML = "";
  Object.values(choicesInstances).forEach(c => { try { c.destroy(); } catch(e){} });
  choicesInstances = {};

  const allHeaders    = Object.keys(data[0]);
  const filterHeaders = FILTER_COLS.filter(h => allHeaders.includes(h));

  filterHeaders.forEach(h => {
    const values = [...new Set(data.map(r => String(r[h] ?? "")))].filter(v => v !== "").sort();

    const wrapper = document.createElement("div");
    wrapper.className = "filter-item";

    const label = document.createElement("div");
    label.className = "filter-label";
    label.innerText = h;

    const select = document.createElement("select");
    select.multiple = true;
    select.id = `fcol_${h.replace(/\s+/g,'_')}`;

    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v; opt.innerText = v;
      select.appendChild(opt);
    });

    wrapper.appendChild(label);
    wrapper.appendChild(select);
    area.appendChild(wrapper);

    const inst = new Choices(select, {
      removeItemButton: true,
      shouldSort:       false,
      searchEnabled:    true,
      placeholderValue: "Select...",
      noResultsText:    "No results",
      itemSelectText:   ""
    });
    choicesInstances[h] = inst;
    select.addEventListener("change", () => applyFilters());

    // Position dropdown correctly above map/other elements
    const choicesEl = select.closest('.choices');
    if (choicesEl) {
      choicesEl.addEventListener('click', () => {
        setTimeout(() => {
          const dropdown = choicesEl.querySelector('.choices__list--dropdown');
          if (!dropdown || !dropdown.classList.contains('is-active')) return;
          const inner = choicesEl.querySelector('.choices__inner');
          if (!inner) return;
          const rect = inner.getBoundingClientRect();
          dropdown.style.position = 'fixed';
          dropdown.style.top      = (rect.bottom + 2) + 'px';
          dropdown.style.left     = rect.left + 'px';
          dropdown.style.width    = rect.width + 'px';
          dropdown.style.zIndex   = '99999';
        }, 0);
      });
    }
  });

  const clearWrapper = document.createElement("div");
  clearWrapper.className = "filter-item d-flex align-items-end";
  clearWrapper.innerHTML = `<button class="btn btn-sm btn-outline-danger w-100 mt-auto" onclick="clearAllFilters()">üóëÔ∏è Clear All</button>`;
  area.appendChild(clearWrapper);
}

// ===== Build Table Header =====
function buildTableHeader(headers) {
  document.querySelector("#dataTable thead").innerHTML =
    "<tr>" + headers.map(h => `<th class="text-nowrap">${h}</th>`).join("") + "</tr>";
}

// ===== Render Table Rows =====
function renderRows(rows) {
  const tbody          = document.querySelector("#dataTable tbody");
  const visibleHeaders = Object.keys(currentData[0]).filter(h => !HIDDEN_COLS.includes(h));

  document.getElementById("totalCount").innerText = "Total Customers: " + rows.length;

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="${visibleHeaders.length}" class="text-center text-muted py-3">No matching records found</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r =>
    "<tr>" + visibleHeaders.map(h => {
      const val = cellValue(h, r[h]);
      return `<td onclick="this.classList.toggle('expand')" title="${String(val)}">${val}</td>`;
    }).join("") + "</tr>"
  ).join("");
}

// ===== Dashboard =====
function renderDashboard(rows) {
  const dashboard  = document.getElementById("dashboard");
  const bySalesman = {};
  rows.forEach(r => {
    if (r.Salesman) bySalesman[r.Salesman] = (bySalesman[r.Salesman] || 0) + 1;
  });
  dashboard.innerHTML = "";

  const allCard = document.createElement("div");
  allCard.className = "dashboard-card";
  allCard.style.background = "#198754";
  allCard.innerHTML = `<strong>All</strong><br>${currentData.length} customers`;
  allCard.onclick = () => clearAllFilters();
  dashboard.appendChild(allCard);

  Object.entries(bySalesman).sort((a, b) => b[1] - a[1]).forEach(([s, c]) => {
    const card = document.createElement("div");
    card.className = "dashboard-card";
    card.innerHTML = `<strong>${s}</strong><br>${c} customers`;
    card.onclick = () => filterBySalesman(s);
    dashboard.appendChild(card);
  });
}

// ===== Filter by Salesman =====
function filterBySalesman(salesman) {
  clearAllFilters(false);
  const inst = choicesInstances["Salesman"];
  if (inst) {
    inst.setChoiceByValue(salesman);
    filtersVisible = true;
    document.getElementById("filtersArea").classList.add("visible");
  }
  applyFilters();
}

// ===== Apply Filters =====
function applyFilters() {
  let filtered    = currentData;
  let activeCount = 0;

  Object.entries(choicesInstances).forEach(([col, inst]) => {
    const selected = inst.getValue(true);
    if (selected && selected.length) {
      activeCount += selected.length;
      filtered = filtered.filter(r => selected.includes(String(r[col] ?? "")));
    }
  });

  const badge = document.getElementById("filterBadge");
  badge.innerText = activeCount;
  badge.style.display = activeCount > 0 ? "flex" : "none";

  renderRows(filtered);
  renderDashboard(filtered);
  updateMap(filtered);
}

// ===== Clear All Filters =====
function clearAllFilters(rerender = true) {
  Object.values(choicesInstances).forEach(inst => inst.removeActiveItems());
  document.getElementById("filterBadge").style.display = "none";
  if (rerender) {
    renderRows(currentData);
    renderDashboard(currentData);
    updateMap(currentData);
  }
}

// ===== Update Map =====
function updateMap(rows) {
  if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const points = [];

  rows.forEach(r => {
    if (r.Latitude && r.Longitude) {
      const lat = parseFloat(r.Latitude);
      const lng = parseFloat(r.Longitude);
      if (isNaN(lat) || isNaN(lng)) return;

      points.push([lat, lng, 0.8]);

      const circle = L.circleMarker([lat, lng], {
        radius: 6, fillColor: "#0d6efd",
        color: "#fff", weight: 1.5,
        opacity: 1, fillOpacity: 0.85
      });
      circle.bindTooltip(String(r['Trade Name'] ?? ''), { permanent: false, direction: "top" });
      circle.addTo(map);
      markers.push(circle);
    }
  });

  if (points.length) {
    heatLayer = L.heatLayer(points, {
      radius: 30, blur: 20, maxZoom: 17,
      gradient: { 0.1: '#000080', 0.3: '#0000ff', 0.5: '#008000', 0.7: '#ff6600', 1.0: '#ff0000' }
    }).addTo(map);
  }
}

loadData();
</script>
</body>
</html>